<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossos Momentos ❤️</title>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <center>
    <div class="heart-background-container" id="slideshow-heart-container"></div>

    <div class="slideshow-page-wrapper">
        <div class="slideshow-header">
            <h1>Nossos Momentos</h1>
        </div>

        <a href="gallery.html" class="close-slideshow-button">
            <i class="fas fa-times"></i> Fechar Apresentação
        </a>

        <div class="slideshow-content-box">
            <div class="audio-player-container">
                <audio id="background-music" loop>
                    <source src="Ed Sheeran - Perfect.mp3" type="audio/mpeg">
                    <source src="music2.mp3" type="audio/mpeg"> Seu navegador não suporta o elemento de áudio.
                </audio>

                <div class="player-top-row">
                    <img src="capa.jpg" alt="Capa da Música" class="music-cover">
                    <div class="song-info">
                        <span id="song-title" class="song-title">Perfect</span>
                        <span id="song-artist" class="song-artist">Ed Sheeran</span>
                    </div>
                    <div class="player-controls">
                        <button class="control-button" id="shuffle-button" title="Embaralhar"><i class="fa-solid fa-shuffle"></i></button>
                        <button class="control-button" id="prev-button" title="Música Anterior"><i class="fa-solid fa-backward-step"></i></button>
                        <button class="control-button play-pause-button" id="play-pause-player" title="Reproduzir/Pausar"><i class="fa-solid fa-play"></i></button>
                        <button class="control-button" id="next-button" title="Próxima Música"><i class="fa-solid fa-forward-step"></i></button>
                        <button class="control-button" id="repeat-button" title="Repetir"><i class="fa-solid fa-repeat"></i></button>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <span id="current-time">0:00</span>
                    <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0">
                    <span id="duration-time">0:00</span>
                </div>
                <div class="volume-control">
                    <i class="fa-solid fa-volume-low"></i>
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="0.5">
                    <i class="fa-solid fa-volume-high"></i>
                </div>
            </div>

            
        </div>
        <div class="slideshow-container">
                <div id="slides-wrapper" class="slides-wrapper">
                    <p id="loadingSlides" class="loading-slides">Carregando fotos para a apresentação...</p>
                </div>
                <a class="prev" onclick="plusSlides(-1)"><i class="fa-solid fa-chevron-left"></i></a>
                <a class="next" onclick="plusSlides(1)"><i class="fa-solid fa-chevron-right"></i></a>
            </div>
    </div>

    <script>
        // --- LÓGICA DO PLAYER DE MÚSICA ---
        const music = document.getElementById('background-music');
        const playPausePlayerButton = document.getElementById('play-pause-player');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeSpan = document.getElementById('current-time');
        const durationTimeSpan = document.getElementById('duration-time');
        const nextButton = document.getElementById('next-button');
        const prevButton = document.getElementById('prev-button');
        const shuffleButton = document.getElementById('shuffle-button');
        const repeatButton = document.getElementById('repeat-button');
        const volumeSlider = document.getElementById('volume-slider');
        const songTitleElement = document.getElementById('song-title');
        const songArtistElement = document.getElementById('song-artist');

        // Playlist de exemplo - adicione mais músicas conforme necessário
        const playlist = [
            { src: "Ed Sheeran - Perfect.mp3", cover: "capa.jpg", title: "Perfect", artist: "Ed Sheeran" },
            // { src: "music2.mp3", cover: "capa2.jpg", title: "Nome da Música 2", artist: "Artista 2" }, // Exemplo
            // { src: "caminho/para/sua/mais_uma_musica.mp3", cover: "caminho/para/sua/mais_uma_capa.jpg", title: "Título", artist: "Artista" }
        ];
        let currentSongIndex = 0;
        let isShuffled = false;
        let shuffledPlaylist = [];

        // Define o volume inicial
        music.volume = volumeSlider.value;

        // Tenta tocar a música automaticamente, caso contrário exibe o botão de play
        music.play().then(() => {
            playPausePlayerButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
        }).catch(error => {
            console.log("Reprodução automática bloqueada. Clique para tocar a música.", error);
            playPausePlayerButton.innerHTML = '<i class="fa-solid fa-play"></i>';
        });

        playPausePlayerButton.addEventListener('click', () => {
            if (music.paused) {
                music.play();
                playPausePlayerButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
            } else {
                music.pause();
                playPausePlayerButton.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
            stopSlideshowInterval(); // Quando interage com o player, pausa o slideshow automático
        });

        music.addEventListener('timeupdate', () => {
            if (!isNaN(music.duration)) {
                const progress = (music.currentTime / music.duration) * 100;
                progressBar.value = progress;
                progressBar.style.setProperty('--progress', `${progress}%`);
                currentTimeSpan.textContent = formatTime(music.currentTime);
            }
        });

        music.addEventListener('loadedmetadata', () => {
            if (!isNaN(music.duration)) {
                durationTimeSpan.textContent = formatTime(music.duration);
                progressBar.max = 100;
            }
        });

        progressBar.addEventListener('input', () => {
            if (!isNaN(music.duration)) {
                const time = (progressBar.value / 100) * music.duration;
                music.currentTime = time;
            }
            stopSlideshowInterval(); // Pausa o slideshow ao mover a barra de progresso
        });

        volumeSlider.addEventListener('input', () => {
            music.volume = volumeSlider.value;
        });

        music.addEventListener('ended', () => {
            if (!music.loop) {
                playNextSong();
            }
        });

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function playNextSong() {
            const currentList = isShuffled ? shuffledPlaylist : playlist;
            if (currentList.length > 0) {
                currentSongIndex = (currentSongIndex + 1) % currentList.length;
                loadAndPlaySong(currentList[currentSongIndex]);
            }
        }

        function playPrevSong() {
            const currentList = isShuffled ? shuffledPlaylist : playlist;
            if (currentList.length > 0) {
                currentSongIndex = (currentSongIndex - 1 + currentList.length) % currentList.length;
                loadAndPlaySong(currentList[currentSongIndex]);
            }
        }

        function loadAndPlaySong(song) {
            music.src = song.src;
            document.querySelector('.music-cover').src = song.cover;
            songTitleElement.textContent = song.title;
            songArtistElement.textContent = song.artist;
            music.load();
            music.play().then(() => {
                playPausePlayerButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
            }).catch(error => {
                console.warn("Falha ao tocar música automaticamente:", error);
                playPausePlayerButton.innerHTML = '<i class="fa-solid fa-play"></i>';
            });
            setTimeout(startSlideshowInterval, 500); // Reinicia o slideshow após nova música
        }

        nextButton.addEventListener('click', () => {
            playNextSong();
            stopSlideshowInterval();
        });
        prevButton.addEventListener('click', () => {
            playPrevSong();
            stopSlideshowInterval();
        });

        shuffleButton.addEventListener('click', () => {
            isShuffled = !isShuffled;
            if (isShuffled) {
                shuffledPlaylist = [...playlist].sort(() => Math.random() - 0.5);
                shuffleButton.classList.add('active');
                currentSongIndex = 0;
                loadAndPlaySong(shuffledPlaylist[currentSongIndex]);
            } else {
                shuffleButton.classList.remove('active');
                const currentSongSrc = music.src.split('/').pop();
                currentSongIndex = playlist.findIndex(song => song.src.includes(currentSongSrc));
                if (currentSongIndex === -1) currentSongIndex = 0;
                loadAndPlaySong(playlist[currentSongIndex]);
            }
            console.log(`Shuffle ${isShuffled ? 'ativado' : 'desativado'}`);
            stopSlideshowInterval();
        });

        repeatButton.addEventListener('click', () => {
            music.loop = !music.loop;
            repeatButton.classList.toggle('active', music.loop);
            console.log(`Repetição ${music.loop ? 'ativada' : 'desativada'}`);
        });

        if (playlist.length > 0) {
            loadAndPlaySong(playlist[currentSongIndex]);
        }
        // --- FIM Lógica do Player de Música ---

        // --- Lógica do Slideshow ---
        let slideIndex = 0;
        let memoriesData = [];
        let slideshowInterval;
        const RENDER_API_URL = 'https://web-production-14bba.up.railway.app';

        function showSlides(n) {
            let slides = document.getElementsByClassName("slide");
            const prevButton = document.querySelector('.slideshow-container .prev');
            const nextButton = document.querySelector('.slideshow-container .next');

            if (slides.length === 0) {
                document.getElementById('loadingSlides').textContent = 'Nenhuma memória para a apresentação. Adicione algumas na galeria!';
                document.getElementById('loadingSlides').style.color = 'red';
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
                return;
            }

            prevButton.style.display = 'flex';
            nextButton.style.display = 'flex';

            if (n > slides.length - 1) {slideIndex = 0}
            else if (n < 0) {slideIndex = slides.length - 1}
            else {slideIndex = n;}

            const currentActiveSlide = document.querySelector('.slide.active');
            if (currentActiveSlide) {
                anime({
                    targets: currentActiveSlide,
                    opacity: 0,
                    scale: 0.9,
                    duration: 500,
                    easing: 'easeInQuad',
                    complete: () => {
                        currentActiveSlide.classList.remove('active');
                        anime({
                            targets: slides[slideIndex],
                            opacity: [0, 1],
                            scale: [0.9, 1],
                            duration: 800,
                            easing: 'easeOutQuad',
                            begin: () => {
                                slides[slideIndex].classList.add('active');
                            }
                        });
                    }
                });
            } else {
                slides[slideIndex].classList.add('active');
                anime({
                    targets: slides[slideIndex],
                    opacity: [0, 1],
                    scale: [0.9, 1],
                    duration: 800,
                    easing: 'easeOutQuad',
                });
            }
        }

        function plusSlides(n) {
            stopSlideshowInterval();
            showSlides(slideIndex += n);
            startSlideshowInterval();
        }

        function startSlideshowInterval() {
            if (memoriesData.length === 0) return;
            clearInterval(slideshowInterval);
            slideshowInterval = setInterval(() => {
                plusSlides(1);
            }, 6000);
        }

        function stopSlideshowInterval() {
            clearInterval(slideshowInterval);
        }

        async function loadSlideshowMemories() {
            const loadingMessage = document.getElementById('loadingSlides');
            const slidesWrapper = document.getElementById('slides-wrapper');
            const prevButton = document.querySelector('.slideshow-container .prev');
            const nextButton = document.querySelector('.slideshow-container .next');

            if (loadingMessage) {
                loadingMessage.textContent = 'Carregando fotos para a apresentação...';
                loadingMessage.style.display = 'block';
            }
            
            prevButton.style.display = 'none';
            nextButton.style.display = 'none';

            try {
                const response = await fetch(`${RENDER_API_URL}/api/memories`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar memórias.');
                }
                memoriesData = await response.json();

                memoriesData.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

                slidesWrapper.innerHTML = '';

                if (memoriesData.length === 0) {
                    slidesWrapper.innerHTML = '<p id="loadingSlides" class="loading-slides error-loading">Nenhuma memória para a apresentação. Adicione algumas na galeria!</p>';
                } else {
                    memoriesData.forEach(memory => {
                        const slideDiv = document.createElement('div');
                        slideDiv.classList.add('slide');
                        slideDiv.innerHTML = `
                            <img src="${memory.image_path}" alt="Memória de ${memory.event_date}">
                            <div class="slide-caption">${memory.description}</div>
                            <div class="slide-date">${new Date(memory.event_date).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        `;
                        slidesWrapper.appendChild(slideDiv);
                    });
                    showSlides(slideIndex);
                    startSlideshowInterval();
                }
            } catch (error) {
                console.error('Erro ao carregar memórias para slideshow:', error);
                slidesWrapper.innerHTML = '<p id="loadingSlides" class="loading-slides error-loading">Não foi possível carregar as memórias para a apresentação.</p>';
            }
        }

        const slideshowContainer = document.querySelector('.slideshow-container');
        slideshowContainer.addEventListener('mouseover', stopSlideshowInterval);
        slideshowContainer.addEventListener('mouseleave', () => {
            if (memoriesData.length > 0) {
                startSlideshowInterval();
            }
        });

        // Este player agora está dentro da caixa, então o hover deve ser na própria caixa ou no player
        document.querySelector('.audio-player-container').addEventListener('mouseover', stopSlideshowInterval);
        document.querySelector('.audio-player-container').addEventListener('mouseleave', () => {
            if (memoriesData.length > 0 && !music.paused) {
                startSlideshowInterval();
            }
        });


        // Lógica para gerar corações caindo
        function createFallingHeart() {
            const heart = document.createElement('span');
            heart.classList.add('falling-heart');
            heart.innerHTML = '❤️';

            const startX = Math.random() * window.innerWidth;
            const randomSize = Math.random() * (2.5 - 1.5) + 1.5;
            const randomDuration = Math.random() * (10 - 6) + 6;
            const randomDelay = Math.random() * 5;

            heart.style.left = `${startX}px`;
            heart.style.fontSize = `${randomSize}em`;
            heart.style.animationDuration = `${randomDuration}s`;
            heart.style.animationDelay = `${randomDelay}s`;
            heart.style.setProperty('--random-x', `${(Math.random() - 0.5) * 100}px`);

            document.getElementById('slideshow-heart-container').appendChild(heart);

            heart.addEventListener('animationend', () => {
                heart.remove();
            });
        }

        let heartInterval = setInterval(createFallingHeart, 800);

        document.addEventListener('DOMContentLoaded', loadSlideshowMemories);
    </script>
    </center>
</body>
</html>